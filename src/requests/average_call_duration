newdb=# select * from t;
 kt |   nt    | monthfee | monthmins | minfee
----+---------+----------+-----------+--------
  1 | Mini    |   400.00 |       300 |   1.00
  2 | Average |   200.00 |       150 |   3.00
  3 | Maxi    |     0.00 |         0 |   5.00
(3 rows)

newdb=# select * from f;
 idcall |  ks  |             dt             | dur
--------+------+----------------------------+-----
 120006 | 1001 | 2018-01-01 10:00:00+03     |  20
 120007 | 1001 | 2018-01-02 10:10:00+03     |  30
 120008 | 1001 | 2018-01-03 10:00:00+03     |   2
 120009 | 1001 | 2018-01-04 10:00:00+03     |   5
 120011 | 1003 | 2018-01-03 10:00:00+03     |  10
 120012 | 1003 | 2018-01-04 10:00:00+03     |  11
 120013 | 1003 | 2018-01-05 10:00:00+03     |  15
 120014 | 1004 | 2018-01-02 10:00:00+03     |  20
 120015 | 1005 | 2018-01-08 11:00:00+03     |   3
 120016 | 1006 | 2018-01-05 10:00:00+03     |  10
 120017 | 1006 | 2018-01-06 10:00:00+03     |  10
 120018 | 1007 | 2019-07-15 07:30:26.928+03 |  21
 120033 | 1001 | 2018-01-01 11:00:00+03     |   4
 120010 | 1002 | 2018-01-07 10:00:00+03     | 160
 120027 | 1002 | 2021-11-12 11:35:35.688+03 | 100
 120028 | 1002 | 2021-11-12 11:36:02.278+03 | 100
 120029 | 1002 | 2021-11-18 14:26:24.829+03 | 100
 120030 | 1002 | 2021-11-18 14:26:58.825+03 | 100
 120031 | 1005 | 2021-11-18 15:44:40.388+03 |  20
 120032 | 1005 | 2021-11-18 15:45:19.303+03 |  50
 120035 | 1005 | 2021-11-18 15:46:59.869+03 |  50
(21 rows)

newdb=# CREATE OR REPLACE FUNCTION avg_dur_of_all() RETURNS numeric AS
newdb-# $$
newdb$# SELECT AVG(dur) FROM public.f
newdb$# $$ LANGUAGE SQL;
CREATE FUNCTION
newdb=# --analytical func
newdb=# SELECT DISTINCT s.ks, AVG(dur) OVER(PARTITION BY s.ks) - AVG(dur) OVER(PARTITION BY s.kt) AS between_t,
newdb-#     AVG(dur) OVER(PARTITION BY s.ks) - avg_dur_of_all()  AS between_all_dur
newdb-# FROM public.f INNER JOIN public.s ON (f.ks = s.ks);
  ks  |      between_t       |   between_all_dur
------+----------------------+----------------------
 1001 |   0.0000000000000000 | -27.8476190476190476
 1002 |  43.5555555555555556 |  71.9523809523809524
 1003 | -56.4444444444444444 | -28.0476190476190476
 1004 | -48.4444444444444444 | -20.0476190476190476
 1005 |   7.3214285714285714 |  -9.2976190476190476
 1006 | -13.4285714285714286 | -30.0476190476190476
 1007 |  -2.4285714285714286 | -19.0476190476190476
(7 rows)